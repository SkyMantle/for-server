<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>üõ∏ Drone Geo-Localization</title>
	<style>
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}

		body {
			font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
			background: #f5f5f5;
			padding: 20px;
		}

		.container {
			max-width: 90vw;
			margin: 0 auto;
		}

		h1 {
			font-size: 28px;
			color: #333;
			margin-bottom: 20px;
		}

		.tabs {
			display: flex;
			border-bottom: 1px solid #e0e0e0;
			margin-bottom: 20px;
		}

		.tab-button {
			padding: 10px 20px;
			cursor: pointer;
			background: white;
			border: 1px solid #e0e0e0;
			border-bottom: none;
			border-radius: 6px 6px 0 0;
			margin-right: 5px;
		}

		.tab-button.active {
			font-weight: bold;
			box-shadow: 0 -2px 4px rgba(0, 0, 0, 0.05);
		}

		.tab-panel {
			display: none;
			background: white;
			padding: 20px;
			border-radius: 0 6px 6px 6px;
			box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
		}

		.tab-panel.active {
			display: block;
		}

		.row {
			display: flex;
			gap: 20px;
		}

		.column {
			flex: 1;
			padding: 20px;
			background: white;
			border-radius: 6px;
			box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
		}

		button {
			flex: 1;
			padding: 12px;
			border: none;
			border-radius: 6px;
			cursor: pointer;
			font-weight: bold;
			font-size: 16px;
			transition: all 0.2s;
		}

		.primary {
			background: #667eea;
			color: white;
		}

		.primary:hover {
			background: #5568d3;
		}

		.secondary {
			background: #999;
			color: white;
		}

		.secondary:hover {
			background: #888;
		}

		.stop {
			background: #ff0000;
			color: white;
		}

		.stop:hover {
			background: #cc0000;
		}

		input {
			width: 100%;
			padding: 12px;
			margin: 8px 0;
			border: 1px solid #e0e0e0;
			border-radius: 6px;
		}

		label {
			display: block;
			margin-top: 10px;
			font-weight: bold;
			color: #333;
		}

		select {
			width: 100%;
			padding: 12px;
			margin: 8px 0;
			border: 1px solid #e0e0e0;
			border-radius: 6px;
		}

		.group {
			background: #f5f5f5;
			padding: 15px;
			border-radius: 8px;
			margin-top: 10px;
		}

		.status {
			margin-top: 10px;
			font-size: 16px;
			color: #666;
			white-space: pre-line;
		}

		img {
			max-width: 100%;
			border-radius: 8px;
			box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
		}

		.hidden {
			display: none;
		}
	</style>
</head>

<body>
	<div class="container">
		<h1>üõ∏ Drone Geo-Localization</h1>
		<div class="tabs">
			<div class="tab-button active" data-tab="image-localization">üñºÔ∏è Image Localization</div>
			<div class="tab-button" data-tab="desktop-streaming">üé• Desktop Streaming</div>
		</div>

		<div id="image-localization" class="tab-panel active">
			<div class="row">
				<div class="column">
					<label for="drone-image">Upload Drone Image</label>
					<input type="file" id="drone-image" accept="image/*">
					<label for="coords-str">Coordinates (lat, lon)</label>
					<input type="text" id="coords-str" value="48.9833, 37.8000">
					<label for="search-radius">Search Radius (km)</label>
					<input type="number" id="search-radius" value="30" min="1">
					<label for="grid-size">Grid Size</label>
					<input type="number" id="grid-size" value="5" min="1" max="20">
					<label for="algorithm">Algorithm</label>
					<select id="algorithm">
						<option value="basic">Basic - Fast</option>
						<option value="fast">Fast</option>
						<option value="balanced" selected>Balanced</option>
						<option value="enhanced">Enhanced</option>
					</select>
					<label><input type="checkbox" id="use-parallel" checked> Use Parallel Processing</label>
					<label for="comparison-method">Comparison Method</label>
					<select id="comparison-method">
						<option value="cosine">Cosine - Fastest</option>
						<option value="enhanced">Enhanced</option>
						<option value="ssim">SSIM</option>
						<option value="correlation">Correlation</option>
						<option value="euclidean">Euclidean</option>
					</select>
					<button class="primary" onclick="localize()">Localize</button>
					<div id="output-map"></div>
				</div>
			</div>
		</div>

		<div id="desktop-streaming" class="tab-panel">
			<div class="row">
				<div class="column">
					<h3>Screen Region Selection</h3>
					<button class="primary" onclick="selectArea()">üñ±Ô∏è Select Screen Area</button>
					<button class="secondary" onclick="clearRegion()">üóëÔ∏è Clear Selection (Full Screen)</button>
					<div class="group">
						<label for="region-x">Region X</label>
						<input type="number" id="region-x" value="0" min="0">
						<label for="region-y">Region Y</label>
						<input type="number" id="region-y" value="0" min="0">
						<label for="region-w">Region Width</label>
						<input type="number" id="region-w" value="1920" min="50">
						<label for="region-h">Region Height</label>
						<input type="number" id="region-h" value="1080" min="50">
					</div>
					<div class="status" id="region-status">No region selected ‚Äì full screen</div>
				</div>
				<div class="column">
					<h3>Recording Controls</h3>
					<button class="primary" onclick="startRecording()">‚ñ∂Ô∏è Start Recording Desktop</button>
					<button class="stop" onclick="stopRecording()">‚èπÔ∏è Stop Recording</button>
					<div class="status" id="stats-display">### üìä Live Stats\n- **Status**: üî¥ Stopped\n- **FPS**: 0.0\n-
						**Frames**: 0\n- **Region**: Full screen</div>
				</div>
			</div>
			<div class="row">
				<img id="live-feed" src="" alt="Live Desktop Video Stream">
			</div>
		</div>
	</div>

	<script>
		// Tab switching
		document.querySelectorAll('.tab-button').forEach(button => {
			button.addEventListener('click', () => {
				document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'))
				document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'))
				button.classList.add('active')
				document.getElementById(button.dataset.tab).classList.add('active')
			})
		})

		// Select area - server screenshot -> popup
		async function selectArea() {
			const resp = await fetch('/get_screenshot')
			const data = await resp.json()
			if (data.b64) {
				localStorage.setItem('screenshot_b64', data.b64)
				const popup = window.open('/select_region', 'regionSelector', 'width=1280,height=920,resizable=yes,scrollbars=yes')
				if (!popup) {
					alert('Popup blocked! Please allow popups for this site.')
					localStorage.removeItem('screenshot_b64')
				}
			} else {
				alert('Failed to get screenshot from server')
			}
		}

		// Receive coords from popup
		window.addEventListener('message', (event) => {
			if (event.data.type === 'region-selected') {
				document.getElementById('region-x').value = event.data.x
				document.getElementById('region-y').value = event.data.y
				document.getElementById('region-w').value = event.data.w
				document.getElementById('region-h').value = event.data.h
				updateRegionStatus()
				localStorage.removeItem('screenshot_b64')
			}
		})

		function clearRegion() {
			document.getElementById('region-x').value = 0
			document.getElementById('region-y').value = 0
			document.getElementById('region-w').value = 1920
			document.getElementById('region-h').value = 1080
			updateRegionStatus()
		}

		function updateRegionStatus() {
			const x = parseInt(document.getElementById('region-x').value) || 0
			const y = parseInt(document.getElementById('region-y').value) || 0
			const w = parseInt(document.getElementById('region-w').value) || 1920
			const h = parseInt(document.getElementById('region-h').value) || 1080
			let status = ''
			if (w < 50 || h < 50) {
				status = '‚ö†Ô∏è Selection too small (minimum 50√ó50)'
			} else if (x === 0 && y === 0 && w === 1920 && h === 1080) {
				status = 'No region selected ‚Äì full screen'
			} else {
				status = `Selected: X=${x} Y=${y} W=${w} H=${h}`
			}
			document.getElementById('region-status').textContent = status
		}

		async function startRecording() {
			const data = {
				x: document.getElementById('region-x').value,
				y: document.getElementById('region-y').value,
				w: document.getElementById('region-w').value,
				h: document.getElementById('region-h').value
			}
			const resp = await fetch('/start_capture', {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify(data)
			})
			const result = await resp.json()
			document.getElementById('stats-display').textContent = result.status
			if (result.status.includes('started')) {
				// Use MJPEG stream for smooth video (like Google Meet)
				document.getElementById('live-feed').src = '/video_stream?' + new Date().getTime() // Cache bust
				setInterval(updateStats, 1000)
			}
		}

		async function stopRecording() {
			const resp = await fetch('/stop_capture', { method: 'POST' })
			const result = await resp.json()
			document.getElementById('stats-display').textContent = result.status
			document.getElementById('live-feed').src = '' // Stop the video stream
		}

		function updateStats() {
			fetch('/get_stats')
				.then(response => response.json())
				.then(data => {
					document.getElementById('stats-display').textContent = data.status_text
				})
		}

		function localize() {
			// Placeholder for your localization function
			document.getElementById('output-map').innerHTML = '<p>Localization results would appear here.</p>'
		}
	</script>
</body>

</html>